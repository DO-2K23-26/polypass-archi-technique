= Search

We want to search by:

- tags
- credential title
- folders
- web site
- identifier
- custom fields

== Collect data
A event is call when a credential, tag and folder is created, updated or deleted. This event is used to update the search engine.

For each event we have a topic in Kafka. The topic name is the event name. 

[source,json]
----
{
    type: string;
}
----

[source,json]
----
{
    "CreateTagEvent": {
        "type": "object",
        "properties": {
            "id_tag": { "type": "string" },
            "id_folder": { "type": "string" },
            "name_tag": { "type": "string" }
        },
        "required": ["id_tag", "id_folder", "name_tag"]
    }
}
----

[source,json]
----
{
    "CreateFolderEvent": {
        "type": "object",
        "properties": {
            "id_folder": { "type": "string" },
            "name_folder": { "type": "string" }
        },
        "required": ["id_folder", "name_folder"]
    }
}
----

[source,json]
----
{
    "CreateCredentialEvent": {
        "type": "object",
        "properties": {
            "id_credential": { "type": "string" },
            "id_folder": { "type": "string" },
            "title_credential": { "type": "string" }
        },
        "required": ["id_credential", "id_folder", "title_credential"]
    }
}
----

[source,json]
----
{
    "UpdateTagEvent": {
        "type": "object",
        "properties": {
            "id_tag": { "type": "string" },
            "id_folder": { "type": "string" },
            "name_tag": { "type": "string" }
        },
        "required": ["id_tag"]
    }
}
----

[source,json]
----
{
    "UpdateFolderEvent": {
        "type": "object",
        "properties": {
            "id_folder": { "type": "string" },
            "name_folder": { "type": "string" }
        },
        "required": ["id_folder"]
    }
}
----

[source,json]
----
{
    "UpdateCredentialEvent": {
        "type": "object",
        "properties": {
            "id_credential": { "type": "string" },
            "title_credential": { "type": "string" }
        },
        "required": ["id_credential", "title_credential"]
    }
}
----

[source,json]
----
{
    "DeleteTagEvent": {
        "type": "object",
        "properties": {
            "id_tag": { "type": "string" }
        },
        "required": ["id_tag"]
    }
}
----

[source,json]
----
{
    "DeleteFolderEvent": {
        "type": "object",
        "properties": {
            "id_folder": { "type": "string" }
        },
        "required": ["id_folder"]
    }
}
----

[source,json]
----
{
    "DeleteCredentialEvent": {
        "type": "object",
        "properties": {
            "id_credential": { "type": "string" }
        },
        "required": ["id_credential"]
    }
}
----



== Search engine
This concerns tags, folders and credentials titles.

We search a credential title, a tag or a folder by name. We get all id of tags or folders with a name containing the search string and we get the list of credentials associated with it.

== Local search fields

== Architecture decisions

=== Search use-case communication flow

This could be a sequence diagram, and a use-case diagram.

1. User types a search string in the search bar.
2. Frontend fetches /search/tags
The search string is sent to the search engine. The search engine returns a list of tags, folders and credentials that match the search string.

=== Search Engine thingy

Elasticsearch

=== Events

==== Events to listen to

Resource creation events:

- Tag creation
- Credential creation
- Folder creation

==== Events to answer to

=== Database Architecture

NoSQL document database

- Tags collection
- Credentials collection
- Folder collection

{
    tag_id: String
    credential_id: String
    folder_id: String
}



== Api 

=== Search

=== API Routes Overview

==== Search Tags by Name

* **Route**: `GET /search/tags`
* **Query Parameters**:
  - `name` (optional): A string representing the partial or full name of the tag to search for.
* **Response**:
  - **200 OK**: Returns a JSON array of tags matching the search criteria.
    Each tag object contains:
    - `id_tag`: The unique identifier of the tag (string).
    - `name_tag`: The name of the tag (string).

==== Search Folders by Name

* **Route**: `GET /search/folders`
* **Query Parameters**:
  - `name` (optional): A string representing the partial or full name of the folder to search for.
* **Response**:
  - **200 OK**: Returns a JSON array of folders matching the search criteria.
    Each folder object contains:
    - `id_folder`: The unique identifier of the folder (string).
    - `name_folder`: The name of the folder (string).

==== Search Credentials by Title

* **Route**: `GET /search/credentials`
* **Query Parameters**:
  - `title` (optional): A string representing the partial or full title of the credential to search for.
  - `tag_ids` (optional): An array of strings representing tag IDs to filter credentials.
  - `folder_id` (optional): A string representing the folder ID to filter credentials.
* **Response**:
  - **200 OK**: Returns a JSON array of credentials matching the search criteria.
    Each credential object contains:
    - `id_credential`: The unique identifier of the credential (string).
    - `title_credential`: The title of the credential (string).


=== Search by Title

[mermaid]
----
sequenceDiagram
    participant User
    participant Frontend
    participant Backend
    participant SearchEngine

    User->>Frontend: Enter search string
    Frontend->>Backend: GET /search/credentials?title={searchString}
    Backend->>SearchEngine: Query credentials by title
    SearchEngine-->>Backend: Return matching credentials
    Backend-->>Frontend: Return credentials list
    Frontend-->>User: Display credentials
----

=== Search by Title and Folder

[mermaid]
----
sequenceDiagram
    participant User
    participant Frontend
    participant Backend
    participant SearchEngine

    User->>Frontend: Enter folder name
    Frontend->>Backend: GET /search/folders?name={folderName}
    Backend->>SearchEngine: Query folders by name
    SearchEngine-->>Backend: Return matching folders
    Backend-->>Frontend: Return folders list
    Frontend-->>User: Display folders for selection
    User->>Frontend: Select a folder
    Frontend->>Backend: GET /search/credentials?title={searchString}&folder_id={selectedFolderId}
    Backend->>SearchEngine: Query credentials by title and folder ID
    SearchEngine-->>Backend: Return filtered credentials
    Backend-->>Frontend: Return credentials list
    Frontend-->>User: Display filtered credentials
----

=== Search by Title and Tags

[mermaid]
----
sequenceDiagram
    participant User
    participant Frontend
    participant Backend
    participant SearchEngine

    User->>Frontend: Enter search string with tag filter
    Frontend->>Backend: GET /search/tags?name={searchString}
    Backend->>SearchEngine: Query tags by name
    SearchEngine-->>Backend: Return matching tags
    Backend-->>Frontend: Return tags list
    Frontend-->>User: Display tags for selection
    User->>Frontend: Select tags
    Frontend->>Backend: GET /search/credentials?tag_ids={selectedTagIds}
    Backend->>SearchEngine: Query credentials by selected tag IDs
    SearchEngine-->>Backend: Return filtered credentials
    Backend-->>Frontend: Return credentials list
    Frontend-->>User: Display filtered credentials
----